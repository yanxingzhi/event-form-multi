<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>报名表</title>
  <link rel="stylesheet" href="data/style.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>报名表</h2>
  <form id="signup-form">
    <label>イベント名：
      <select id="activityIdSelect" name="activityId" required>
      </select>
    </label>
    <br/>
    <label>お名前：<input name="name" required/></label>
    <label>性別：
      <select name="sex" required>
        <option value="">--</option>
        <option value="Male">男性</option>
        <option value="Female">女性</option>
      </select>
    </label>
    <br/>
    <label>国籍：<input name="nationality" required/></label>
    <label>メールアドレス：<input name="email" type="email" required/></label>
    <label>電話番号：<input name="phone"/></label>
    <label>学校名又は勤務先：<input name="school"/></label>
    <label>留言：<textarea name="message"></textarea></label>
    <button type="submit">提交</button>
  </form>
  <p id="result"></p>

  <script>
    // =========== line ===========
    const liffId = "2007823026-yDgLXZ6k"; // 替换为你的实际 LIFF ID
    const id = new URLSearchParams(location.search).get("id");
    let userProfile = null;

    async function initLIFF() {
      try {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        userProfile = await liff.getProfile();
        console.log("LINE 用户 ID:", userProfile.userId);
      } catch (err) {
        console.error("LIFF 初始化失败:", err);
      }
    }

    async function stateQuery() {
      await initLIFF()

      // ===========查询是否已报名===========
      const res = await fetch(`/api/query?a=${id}&e=${userProfile.userId}`, {
        method: "GET",
      });

      if (res.ok) {
        const resJson = await res.json();
        if (resJson.found) {
          document.body.innerHTML = `
            <div id="content">すでに申し込みを済ませております。</div>
            <button id="cancelBtn">申し込みをキャンセル</button>
          `
          document.getElementById("cancelBtn").addEventListener("click", withLoading(async () => {
              if (!confirm("確認しますか？")) {
                return;
              }
              const res = await fetch("/api/update", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({"a": id,"e": userProfile.userId})
              });

              if (res.ok) {
                clear();
                document.body.innerHTML = `
                  <div id="content">お申し込みはキャンセルされました。</div>
                `
              }
          }))
        } 
      } else {
        alert("ネットワークが混み合っています。")
      }
    }

    async function loadEvents() {
      const select = document.getElementById('activityIdSelect')
      select.addEventListener('change', () => {
      const val = select.value;
      if (val) {
          // 当前基础 URL（不含参数和 hash）
          const baseUrl = window.location.origin + window.location.pathname;

          // 拼接参数，比如 ?eventId=xxx
          const newUrl = `${baseUrl}?id=${encodeURIComponent(val)}`;

          // 跳转
          window.location.href = newUrl;
        }
      });
      try {
        const response = await fetch('./data/events.json');
        if (!response.ok) throw new Error('网络响应错误');

        const events = await response.json();
        console.log('事件数据', events);

        const select = document.getElementById('activityIdSelect');
        events.forEach(event => {
          const option = document.createElement('option');
          option.value = event.id;      // 用事件id做value
          option.textContent = event.title; // 显示事件标题

          if (id == event.id) {
            option.selected = true;
          }
          select.appendChild(option);
        });
      } catch (error) {
        console.error('加载事件数据失败:', error);
      }
    }

    function clear() {
      history.pushState(null, null, location.href);
      window.addEventListener("popstate", function (event) {
        history.pushState(null, null, location.href);
      });
    }

    (async () => {
      await withLoading(loadEvents)();
      await withLoading(stateQuery)();
    })();
    
    function withLoading(asyncFunc) {
      return async function(...args) {
        let mask = document.getElementById("loadingMask");
        if (!mask) {
      // 创建遮罩元素
      mask = document.createElement("div");
      mask.id = "loadingMask";
      Object.assign(mask.style, {
        display: "none",
        position: "fixed",
        top: "0",
        left: "0",
        right: "0",
        bottom: "0",
        background: "rgba(0,0,0,0.3)",
        zIndex: "9999",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
        color: "white",
        fontSize: "1.5em",
        });
        mask.textContent = "読み込み中...";
        document.body.appendChild(mask);
      }
        try {
          mask.style.display = "flex";
          return await asyncFunc(...args);
        } finally {
          mask.style.display = "none";
        }
      }
    }


    // ===========表单提交===========
    const form = document.getElementById("signup-form")
    if (form) {
      form.addEventListener("submit", withLoading(async (e) => {
      e.preventDefault();
      if (!confirm("確認しますか？")) {
        return;
      }
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());

      if (userProfile) {
        data.userId = userProfile.userId;
        data.lineName = userProfile.displayName;
      }

      const res = await fetch("/api/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        document.body.innerHTML = `
            <div id="content">すでに申し込みを済ませております。</div>
            <button id="cancelBtn">申し込みをキャンセル</button>
          `
          document.getElementById("cancelBtn").addEventListener("click", withLoading(async() =>{
              if (!confirm("確認しますか？")) {
                return;
              }
              const res = await fetch("/api/update", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({"a": id,"e": userProfile.userId})
              });

              if (res.ok) {
                clear();
                document.body.innerHTML = `
                  <div id="content">お申し込みはキャンセルされました。</div>
                `
              }
          }))
      } else {
        alert("ネットワークが混み合っています。")
      }
    }));
    }
  </script>
</body>
</html>
